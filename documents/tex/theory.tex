\chapter{Theory}

In this chapter, we give a theoretical introduction to the topic dealt with in this thesis. The ultimate goal of this chapter is to introduce and describe a analytical model for subsurface scattering. First, we will give a brief introduction to what light is, and how we physically describe it. Secondly, we will introduce the basic radiometric quantities that will be used throughout the chapter. Then, we will describe how this quantities are related and can be used to describe light-material interaction, using reflectance functions, of which BSSRDF functions are a special case. Finally, we will introduce subsurface scattering and the diffusion approximation, concluding with a description of two BSSRDF functions actually used to describe it, by \cite{Jensen:2001:PMS:383259.383319} and \cite{IMM2013-06646}.

\section{Light and Radiometry}
Light is a form of electromagnetic radiation, that propagates through space as a sinusoidal wave. Usually by "light` we usually refer to \emph{visible light}, the small part of the electromagnetic spectrum the human eye is sensible to (see Figure \ref{fig:spectrum}). This small window is between the \SI{380}{\nano\meter} of the infrared and \SI{750}{\nano\meter} of the ultraviolet, but the precise boundaries vary according to the environment and the observer. Instead explicitly noted, we will use the terms light and visible light interchangeably in this report.

The study of light is usually referred as optics. In computer aided image synthesis, we are interested in representing faithfully how visible light propagates though the scene and how interacts with materials. In addition, we are usually interested on lighting effects that are noticeable at human scales (\SI{1}{\milli\meter} - \SI{1}{\kilo\meter}). For example, we are interested in subsurface scattering, absorption and emission phenomena but not in diffraction, interference and quantum effects, that for visible light happen on a microscopic scale (\SI{1}{\nano\meter} - \SI{1}{\micro\meter}). 

\begin{figure}[!ht]
\centering
\includegraphics[width=1.0\textwidth]{images/spectrum.pdf}
\caption{The electromagnetic spectrum.}
\label{fig:spectrum}
\end{figure}

The study of the measurement of electromagnetic radiation is called \emph{radiometry}. The energy of light, like all the others forms of energy, is measured in \emph{Joules} [\si{\joule} $=$ \si{\kg\meter\square\per\second\square}], and its power in \emph{Watts} [\si{\watt} $=$ \si{\kg\meter\square\per\second\cubed}]. \emph{Photometry}, on the other hand, measures electromagnetic radiation as it is perceived from the human eye, and limits itself only to the visible spectrum, while radiometry spans all of it. The quantities for energy and power are called respectively \emph{talbot} [\si{\candela\second}] and \emph{candela} [\si{\candela}]. 

In image synthesis radiometry is employed, as its quantities directly derive from the electromagnetic theories, are universal, and can be easily converted to the photometric ones when necessary. The most important radiometric quantities used in computer graphics are \emph{radiant flux}, \emph{radiant energy}, \emph{radiance}, \emph{irradiance} and \emph{intensity}.

\section{Radiometric quantities}

\subsection{Radiant flux}
The radiant flux, also known as radiant power, is the most basic quantity in radiometry. It is usually indicated with the letter $\Phi$ and it is measured in joules per seconds [\si{\joule\per\second}] or Watts [\si{\watt}]. The quantity indicates how much power the light irradiates per unit time. Given its nature, the radiant flux is independent from the distance from the light source.

\subsection{Radiant energy}
Radiant energy, usually indicated as $Q$, is the energy that the light carries in a certain amount of time. Like all the other SI units for energy, it is measured in joules [\si{\joule}]. Radiant energy is usually obtained integrating the radiant flux along time for an interval $\Delta T$:

$$
Q = \int_{\Delta T} \Phi \; dt
$$

Due to the dual nature of the light, the energy carried by the light can be derived both considering the flux of photons as particles, or considering light as a wave. We will not dig further into the topic, because for rendering purposes is not important if we characterize light as a flux of particles or as a sinusoidal wave.

\subsection{Irradiance}

Irradiance, usually defined as $E$, is the radiometric unit that measures the radiant flux per unit area \emph{falling} on a surface. It is measured in Watts per square meter [\si{\watt\per\square\meter}]. It is obtained by further deriving the radiant flux by the area:

$$
E = \frac{d\Phi}{dA}
$$

Irradiance is usually the term in literature used for the \emph{incoming} power per unit area. The converse, i.e. the irradiance leaving a surface, it is usually referred as \emph{radiant exitance} or \emph{radiosity}, and indicated with the letter $B$.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.5\textwidth]{images/irradiance.pdf}
\caption{Irradiance versus power. For the two surfaces $A$ and $B$, the received power $\Phi$ is the same, while the two irradiances $E_A$ and $E_B$ are different, as the area of $B$ is twice as the one of $A$.}
\label{fig:spectrum}
\end{figure}
 

\subsection{Intensity}
Intensity is defined as the differential radiant flux per differential solid angle:

$$
I(\vec{\omega}) = \frac{d \Phi}{d \omega}
$$

It is measured in Watts / steradian [\si{\watt\per\steradian}] and it is indicated with the letter $I$. Intensity is often a misused term in the physics community, as it is used for many different measures. Depending on the community, intensity may refer to irradiance or even to radiance (see the following section). We will refer to intensity as it is generally interpreted by the optics community, i.e. radiant intensity. 


\subsection{Radiance}


\begin{figure}[!ht]
\centering
\includegraphics[width=0.5\textwidth]{images/radiance.pdf}
\caption{Radiance. The element of area $\d A$ gets projected according to the angle $\theta = \cos^{-1}{\vec{n} \cdot \vec{\omega}}$. Then the incoming flux $\Phi$ gets divided by the projected area and by the solid angle subtended by it.}
\label{fig:spectrum}
\end{figure}


Radiance is the most important quantity in image synthesis. It is defined precisely as the differential of the flux per solid angle per projected surface area, and it is measured in Watt per steradian per square meter [\si{\watt\per\steradian\meter\square}].

$$
L(\vec{\omega}) = \frac{d^2 \Phi}{d\omega dA \cos \theta}
$$

Where $\theta$ is the angle between the surface normal and the incoming ray of light (so that $\cos\theta = \vec{n} \cdot \vec{\omega}_i$). Radiance is important in image synthesis because it is the natural quantity to associate with a ray of light, as it remains constant along it. In addition, the sensibility of the human eye to light is directly proportional to the radiance. For a discussion on why radiance is related to the sensitivity of sensors and the human eye, see X.

All the other radiometric quantities can be derived from radiance:

\begin{equation}
\begin{split}
E &= \int_{2\pi} L_i(\vec{\omega}) \cos\theta \; d\omega \\
B &= \int_{2\pi} L_o(\vec{\omega}) \cos\theta \; d\omega \\
I(\vec{\omega}) &= \int_A L(\vec{\omega}) \cos\theta \; dA \\
\Phi &= \int_A \int_{2\pi} L(\vec{\omega}) \cos\theta \; d\omega dA
\end{split}
\label{eq:radiancederivation} 
\end{equation}

For simplicity of notation, in the previous notations the dependence from the point of incidence $\mathbf{x}$ has been dropped. In principle, all the quantities listed in equation \ref{eq:radiancederivation} are dependent on $\mathbf{x}$.

\subsection{Radiometric quantities for simple lights}

To help with the formulas used later in the report, we derive the above mentioned radiometric quantities for the two simplest types of light, i.e. directional and point lights.
\begin{itemize}
	\item \textit{Directional lights} simulate very distant light sources, in which all the rays of light are parallel (e.g. the sun). They are represented by a direction $\vec{\omega}_l$ and a constant radiance value, $L$. 
	\item \textit{Point lights} simulate lights closer to the observer. Isotropic point lights are represented by a position of the light $\mathbf{x}_l$ and a constant intensity $I$. Point lights have a falloff that depends on the inverse square law, i.e. the radiance diminishes with the square of the distance.
\end{itemize}

Table \ref{table:radio} shows different radiometric quantities evaluated for point and directional lights, for a surface point $\mathbf{x}$ with surface normal $\vec{n}$. 

\renewcommand{\arraystretch}{1.8}
\begin{table}[!ht]
    \centering
    \begin{tabularx}{0.95\textwidth}{|X|X|X|}
    \hline
    Quantity   & Directional light & Point light \\ \hline
    Cosine term       & $\cos\theta = \vec{n} \cdot \vec{\omega}_l$ & $\cos\theta = \frac{(\mathbf{x} - \mathbf{x}_l) \cdot \vec{n}}{|\mathbf{x} - \mathbf{x}_l|}$     \\ \hline

    $\Phi(\mathbf{x})$ Flux       & $\infty$                  & $4 \pi I$           \\ \hline
    $E(\mathbf{x})$ Irradiance & $L \cos\theta $                 & $I \frac{\cos\theta}{|\mathbf{x}_l - \mathbf{x}|^2}$          \\ \hline
    $I(\mathbf{x},\vec{\omega})$ Intensity  & $\infty$                 & $I$           \\ \hline
    $L(\mathbf{x},\vec{\omega})$ Radiance   & $L$               & $\frac{I}{|\mathbf{x}_l - \mathbf{x}|^2}$           \\ \hline
    \end{tabularx}
\caption{Different radiometric values for simple light sources. Note that flux and irradiance for a directional light are infinite because they are integrated over an infinite area.}
\label{table:radio}
\end{table}

\section{Reflectance Functions}
 
After introducing the basic radiometric quantities, we still lack a way to describe light material interaction. More precisely, we need a way to relate the incoming and the outgoing radiance on a point of a chosen surface. As we have already discussed before, we use radiance since is the radiometric quantity that is directly proportional to what the human eye measures. 

\subsection{BRDF functions}

One of the possible way to describe light-material interaction is by using a BDRF function, acronym for \emph{Bidirectional Reflectance Distribution Function}. The BRDF function $f(\mathbf{x}, \vec{\omega}_i, \vec{\omega}_o)$ is defined on one point $\mathbf{x}$ of the surface as the differential ratio between the exiting radiance and the incoming irradiance:

\begin{equation}
f(\mathbf{x}, \vec{\omega}_i, \vec{\omega}_o) = \frac{d L_o(\mathbf{x}, \vec{\omega}_o)}{d E_i(\mathbf{x}, \vec{\omega}_i)} = \frac{d L_o(\mathbf{x}, \vec{\omega}_o)}{L_i(\mathbf{x}, \vec{\omega}_i) \cos\theta_i d \vec{\omega}_i}
\label{eq:brdf}
\end{equation}

The BRDF states that the incoming and the outgoing radiance are proportional, so that the energy hitting the material at the point $\mathbf{x}$ is proportional to the energy coming out from the point. The BRDF function is generically reciprocal for the Hemholtz reciprocity principle ( $f(\mathbf{x}, \vec{\omega}_i, \vec{\omega}_o) = f(\mathbf{x}, \vec{\omega}_o, \vec{\omega}_i)$), and anisotropic (if the surface changes orientation and $\vec{\omega}_i$ and $\vec{\omega}_o$ stays the same, the resulting BRDFs are different). In addition, it is positive( $f(\mathbf{x}, \vec{\omega}_o, \vec{\omega}_i) \ge 0$), and conserves energy, so that the energy of the outgoing ray is no grater that the one of the incoming one ($\int_{2\pi}  f(\mathbf{x}, \vec{\omega}_o, \vec{\omega}_i) \cos\theta_o d\vec{\omega}_o \le 1$).

By inverting equation \ref{eq:brdf}, we obtain the so-called \emph{reflectance equation}:

$$
L_o(\mathbf{x}, \vec{\omega}_o) = \int_{2\pi} f(\mathbf{x}, \vec{\omega}_i, \vec{\omega}_o) L_i(\mathbf{x}, \vec{\omega}_i) \cos\theta_i d\vec{\omega}_i
$$

That later we will extend to obtain the rendering equation. The BRDF function has some limitations, being not able to account for all phenomena. For example, with a BRDF it is not possible to account for subsurface scattering phenomena, because it assumes the light enters and leaves the material in the same point. To model these phenomena, more complicated functions are needed, like the BSSRDF function described later in this chapter. 

\subsection{Examples of BRDF functions}

There are many examples of BRDF functions in literature. In this section, we will introduce three of the simplest ones: for a more exhaustive description of BRDF functions, refer to X. The three BRDFs are the lambertian or diffuse BRDF, the specular or mirror BRDF and the family of glossy BRDFs.

\subsubsection{Lambertian BRDF}

In the lambertian BRDF, the incoming radiance is distributed equally in all directions, regardless of the incoming direction. To do this, the BRDF must be constant:

$$
f(\mathbf{x}, \vec{\omega}_i, \vec{\omega}_o) = k_d
$$

We can check that then the radiance is scattered equally in all directions by simple integration:

\begin{equation*}
\begin{split}
L_o(\mathbf{x}, \vec{\omega}_o) &= \int_{2\pi} f_d L_i(\mathbf{x}, \vec{\omega}_i) \cos\theta_i d\vec{\omega}_i \\
L_o(\mathbf{x}, \vec{\omega}_o) &= k_d \int_{2\pi} L_i(\mathbf{x}, \vec{\omega}_i) \cos\theta_i d\vec{\omega}_i \\
L_o(\mathbf{x}, \vec{\omega}_o) &= k_d \; E(\mathbf{x}) \\
\end{split}
\end{equation*}

The lambertian model is an ideal model, so very few material exhibit a lambertian diffusion, like unfinished wood or spectralon, a synthetic material created in order to have a lambertian diffusion. 

\subsubsection{Mirror BRDF}

Another simple kind of BRDF is the perfectly specular BRDF, or mirror BRDF. In this function, all the incoming radiance from one direction $\vec{\omega}_i$ is completely diffused into the reflected direction $\vec{\omega}_r$, defined as $\vec{\omega}_r = \vec{\omega}_i - 2 (\vec{\omega}_i \cdot \vec{n}) \vec{n}$. The resulting BRDF is defined as follows:

$$
f(\mathbf{x}, \vec{\omega}_i, \vec{\omega}_o) = \frac{\delta(\vec{\omega}_o - \vec{\omega}_r)}{\cos\theta_i} 
$$

The function $\delta(\vec{\omega})$ is a hemispheric delta function. Once integrated over a hemisphere, the function evaluates to one only for the vector $\vec{\omega} = \mathbf{0}$. Putting the BRDF into the reflectance equation gives the following outgoing radiance:

\begin{equation*}
L_o(\mathbf{x}, \vec{\omega}_o) = \begin{cases}
L_i(\mathbf{x}, \vec{\omega}_i)  &\text{if $\vec{\omega}_o = \vec{\omega}_r$}\\
0 &\text{otherwise}
\end{cases}
\end{equation*}

that is the expected result, as all the radiance is reflected into the direction $\vec{\omega}_r$.

\subsubsection{Glossy BRDFs}

As we can see from real life experience, rarely objects are completely diffuse or completely specular. These two models are idealized models, that represent an ideal case. So, to create a realistic BRDF model, we often need to combine the two terms and add an additional one, called glossy reflection. This term is often needed to model the behavior of the surface more realistically, especially at grazing angles.

The most used BRDF model used to model glossy reflections is based on microfacet theory. In this theory, the surface of an object is modeled as composed of small mirrors. In one of its classical formulation, the BRDF is represented as:

$$
f(\mathbf{x}, \vec{\omega}_i, \vec{\omega}_o) = \frac{D G R}{4 \cos\theta_r \cos\theta_i} = \frac{G R}{4} \frac{(\vec{n}\cdot\vec{h})^s}{(\vec{n}\cdot\vec{r})(\vec{n}\cdot\vec{\omega}_i)}
$$

$D$ regulates how microfacets are distributed, and it is often modeled as $(\vec{n}\cdot\vec{h})^s$, where $\vec{h}$ is the half vector between the eye and the light, and $s$ is an attenuation parameter. $\vec{h}$ is defined as:

$$
\vec{h} = \frac{\vec{\omega}_o + \vec{\omega}_i}{\left\| \vec{\omega}_o + \vec{\omega}_i \right\|}
$$

$G$ accounts for the object self shadowing, while $R$ is the Fresnel reflection term (more details in section Y).	$\vec{r}$ is the reflection vector as defined in the previous section. See figure Z on how the vectors for the glossy reflection - $\vec{n}$, $\vec{h}$ and $\vec{r}$ - are defined.

Various alternative definitions exist for the $D$ and $G$ function, varying among the literature. Other glossy models not based on microfacet theory do exist as well. 

\subsection{The rendering equation}

Given the reflectance equation, it is possible to generalize it in order to model all the lighting in an environment. In fact, this form of the reflectance equation does not account for two important factors. 

The first factor are emissive surfaces. We need to add an emissive radiance term $L_e(\mathbf{x}, \vec{\omega})$ that models how much radiance is a point on a surface emitting in a certain directions. This is useful to model lights as any other surface in the scene. Note that point lights have a singularity: they emit infinite radiance on the point they are placed.

The second factor is that the reflectance equation accounts only for direct illumination. In general, we want to model global illumination, i.e. to include also light that bounced onto another surface before reaching the current surface. To model this, we can replace the $L_i$ term in the reflectance equation with another term $L_r$ that accounts for reflected radiance. This term can be usually modeled as the product of the radiance of the light plus a visibility function $V(\mathbf{x})$.

Accounting for all the described factors, we reach one formulation of the rendering equation:

$$
L_o(\mathbf{x}, \vec{\omega}_o) = L_e(\mathbf{x}, \vec{\omega}) + \int_{2\pi} f(\mathbf{x}, \vec{\omega}_i, \vec{\omega}_o) L_i(\mathbf{x}, \vec{\omega}_i) V(\mathbf{x}) \cos\theta_i d\vec{\omega}_i
$$

This form of the rendering equation is still not completely general, since it is based on a BRDF, so it is not possible to model subsurface scattering effects or wavelength-changing effects (like iridescence). We will extend the rendering equation in order to account for these phenomena later on in this chapter.

\subsection{Fresnel equations}

Until now, on the described BRDF models, we did consider only the reflected part of the radiance. When a beam of light coming from direction $\vec{\omega}_i$ hits a surface, only part of the incoming radiance gets reflected, while another part gets refracted into the material. As we can see from the setup from figure Z, we obtain the two vectors $\vec{\omega}_r$ and $\vec{\omega}_t$, the reflected and refracted vector, defined as follows:

\begin{equation*}
\begin{split}
\vec{\omega}_r &= \vec{\omega}_i - 2 (\vec{\omega}_i \cdot \vec{n}) \vec{n} \\
\vec{\omega}_t &= \eta ((\vec{\omega}_i \cdot \vec{n}) \vec{n} - \vec{\omega}_i) - \vec{n} \sqrt{1 - \eta^2 (1 - (\vec{\omega}_i \cdot \vec{n}) ^ 2)}
\end{split}
\end{equation*}

Where $\eta = \frac{n_1}{n_2}$ is the relative index of refraction of the material. With this setup, we can use a solution to Maxwell's equations for wave propagation to describe how light spreads between reflected and refracted directions. What we obtain are called \emph{Fresnel coefficients}. The coefficients are different according to the polarization of the incoming light, so there are two for the reflection ($R_s$, $R_p$) and two for transmission ($T_s$, $T_p$). The coefficients relate the incoming and outgoing power of the light, and by differentiation, the radiance as well.

\begin{equation*}
\begin{split}
R_s = \left|\frac{n_1 \cdot \cos\theta_i - n_2 \cdot \cos\theta_t} {n_1 \cdot \cos\theta_i + n_2 \cdot \cos\theta_t}\right|^2 \;\;\;&\;\;\; R_p = \left|\frac{n_1 \cdot \cos\theta_t - n_2 \cdot \cos\theta_i} {n_1 \cdot \cos\theta_t + n_2 \cdot \cos\theta_i}\right|^2\\
T_s = \frac{n_2 \cdot \cos\theta_t}{n_1 \cdot \cos\theta_i} \left|\frac{2 n_1 \cdot \cos\theta_i}{n_1 \cdot \cos\theta_i + n_2 \cdot \cos\theta_t}\right|^2 \;\;\;&\;\;\; T_p = \frac{n_2 \cdot \cos\theta_t}{n_1 \cdot \cos\theta_i}  \left|\frac{2 n_1 \cdot \cos\theta_i}{n_1 \cdot \cos\theta_t + n_2 \cdot \cos\theta_i}\right|^2
\end{split}
\end{equation*}


In most computer graphics applications (and this is reasonable for most of the real-world lights), we assume that the two polarizations are equally mixed. So, we will use the coefficient $R = \frac{R_s + R_p}{2}$ and $T = \frac{T_s + T_p}{2}$ in our calculations. Note that $R + T = 1$, so the overall energy is conserved.

\section{Light transport and subsurface scattering}

When we derive our models for lighting, in general we assume that the light is traveling in vacuum. This assumption holds for light that is propagating though the air (which is assimilable to vacuum), but once we relax it, more variables should be taken into consideration. Objects through which light travels are referred as \emph{participating media}. In this chapter, we will derive and consider an alternative formulation of the rendering equation for light traveling into participating media, called \emph{volume rendering equation}.

When a beam of light travels through an object, various phenomena occur. A photon on the beam can be either being absorbed (disappear), scattered (change direction) or emitted (appear). These phenomena can be uniform throughout the material (homogeneous materials), as in solid material like wax or leaves, or be not uniform (heterogeneous materials), like in smoke or clouds.

We will briefly describe all three mentioned effects, then combine them to compose the volume rendering equation. The purpose is to describe how radiance varies along a beam of light with direction $\vec{\omega}$. This directional derivative is indicated as:

$$
(\vec{\nabla} \cdot \vec{\omega}) L(\mathbf{x}, \vec{\omega}) = \frac{\partial L_x}{\partial x} \vec{\omega}_x + \frac{\partial L_y}{\partial y} \vec{\omega}_y +\frac{\partial L_z}{\partial z} \vec{\omega}_z
$$ 

\subsection{Emission}
Emission is the natural property of the materials to emit light, i.e. to generate photons that add to the existing ones passing through the material. The effect is generally generated by chemical processes emitting photons (as in natural animals like fireflies), by natural black-body radiation emission in the visible spectrum (such as in a star like the sun or in incandescent bulbs), or by other radiation that changed its wavelength into the visible spectrum.

In the directional 3D derivative, the variance in emission is modeled as a constant depending only on the current position and direction.

$$
(\vec{\nabla} \cdot \vec{\omega}) L(\mathbf{x}, \vec{\omega}) = \epsilon(\mathbf{x}, \vec{\omega})
$$

This means that emission increases linearly along the body: if the beam travels a distance $d$ within the medium, $d \cdot k$ photons are emitted. Emission is generally isotropic, not depending on the direction ($ \epsilon(\mathbf{x}, \vec{\omega}) =  \epsilon(\mathbf{x})$).

\subsection{Absorption}
Absorption is a property of materials that models a simple physical phenomenon: a photon, traveling though the material, hits one atom of the material. The energy carried by the photon is then absorbed by the atom, augmenting its kinetic energy. This directly translates in an increase of heat in the material. Usually a certain percentage of the photons hits the atoms and gets absorbed. This means, if $k$ is the percentage of the photons absorbed in a unit, after one unit the original radiance will become $k \cdot L_i$, then $k^2 \cdot L_i$, etc.

If we write this phenomena as a differential equation, we get after a distance $d$ a decaying in radiance of $k^d = e^{-\sigma_a d}$, that leads to the following 3D directional derivative:

$$
(\vec{\nabla} \cdot \vec{\omega}) L(\mathbf{x}, \vec{\omega}) = -\sigma_a(\mathbf{x},\vec{\omega}) L(\mathbf{x}, \vec{\omega})
$$

$\sigma_a$ is referred as the \emph{absorption coefficient}. Also this coefficient is generically isotropic, and constant for homogenous materials.

\subsection{Out-scattering}
Out scattering is the radiance lost due to scattering. The scattering phenomenon happens when photons are deflected away from the current direction $\vec{\omega}$.  As in the previous case, the phenomena is modeled as a percentage of the radiance lost per unit length. So the loss due to out-scattering is modeled as:

$$
(\vec{\nabla} \cdot \vec{\omega}) L(\mathbf{x}, \vec{\omega}) = -\sigma_s(\mathbf{x},\vec{\omega}) L(\mathbf{x}, \vec{\omega})
$$

$\sigma_s$ is referred as the \emph{scattering coefficient}. We note that in this case we are not interested in which direction the photons are actually going. That will be accounted in the in-scattering term of another point in the material.

\subsection{In-scattering}
Given some loss due to some of the photons changing direction, there will be some of them that from other scattering events will change to the $\vec{\omega}$ direction. We need then to discover the number of photons that comes from all the other directions. To do this, we integrate the incoming radiance from all directions in the point $\mathbf{x}$. This quantity, similar to irradiance, in an infinite medium is called \emph{fluence}, and indicated as $\phi$:

$$
\phi(\mathbf{x}) = \int_{4\pi} L(\mathbf{x},\vec{\omega}') d\omega'
$$

This quantity should be then averaged over the entire sphere, yielding $\frac{\phi}{4\pi}$ as a result. This quantity then is then multiplied by the scattering coefficient, because only some photons on average align to the current direction $\vec{\omega}$. This yields:

\begin{equation}
(\vec{\nabla} \cdot \vec{\omega}) L(\mathbf{x}, \vec{\omega}) = \sigma_s(\mathbf{x}) \frac{1}{4 \pi} \int_{4\pi} L(\mathbf{x},\vec{\omega}') d\omega'	
\label{eq:inscatter}
\end{equation}


However, equation \ref{eq:inscatter} assumes that radiance scatters equally in all directions. This is not usually the case, and the $\frac{1}{4 \pi}$ term needs to be replaced by a probability distribution function that describes how the photons scatter in the medium. This function is called phase function, and indicated as $p(\mathbf{x}, \vec{\omega}, \vec{\omega}')$. In the actual models its integral on the hemisphere is often used as a parameter, called \emph{mean cosine} ($g$):

$$
g(\mathbf{x}) = \int_{4 \pi} p(\mathbf{x}, \vec{\omega}, \vec{\omega}') \vec{\omega} \cdot \vec{\omega}' d \omega'
$$

This term indicates the general direction of the scattering in the material. If positive, the scattering is prevalent along the beam (forward scattering), if negative is prevalent in the opposite direction (backward scattering). If zero, the scattering is isotropic, i.e. equal in all directions.

So, the final 3D equation for in-scattering, accounting for the phase function, is as follows:

\begin{equation}
(\vec{\nabla} \cdot \vec{\omega}) L(\mathbf{x}, \vec{\omega}) = \sigma_s(\mathbf{x}) \int_{4\pi} p(\mathbf{x}, \vec{\omega}, \vec{\omega}') L(\mathbf{x},\vec{\omega}') d\omega'	
\label{eq:inscatter}
\end{equation}

\subsection{Final formulation of the volume rendering equation}
Combining emission, absorption, scattering described in the previous sections, we reach the final formulation of the volume rendering equation:

$$
(\vec{\nabla} \cdot \vec{\omega}) L(\mathbf{x}, \vec{\omega}) =   -\sigma_t(\mathbf{x}) L(\mathbf{x}, \vec{\omega}) + \epsilon(\mathbf{x}) + \sigma_s(\mathbf{x}) \int_{4\pi} p(\mathbf{x}, \vec{\omega}, \vec{\omega}') L(\mathbf{x},\vec{\omega}') d\omega'
$$

Where the two reducing term, scattering and absorption, have been combined together in $\sigma_t = \sigma_a + \sigma_s$, called the \emph{extinction coefficient}.


\subsection{BSSRDF functions and generalized rendering equation}

In order to be able to model subsurface scattering 

\subsection{Standard dipole model}
\subsection{Directional dipole model}
